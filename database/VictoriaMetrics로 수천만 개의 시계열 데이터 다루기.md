네이버 검색 SRE의 시계열 데이터베이스 운영기 - VictoriaMetrics로 수천만 개의 시계열 데이터 다루기
=

https://d2.naver.com/helloworld/6867189

> 시계열 데이터 유지보수에 대한 경험담

시계열 데이터
-
시계열 데이터란 시간 순서대로 나열된 숫자 데이터
장비의 지표, 서비스 지표 등 일정한 주기로 시간순으로 수집되는 시계열 데이터

시계열 데이터(지표) 저장
-
VictoriaMetrics는 SingleNode 버전과 Cluster 버전을 제공

- SingleNode 버전
  - 장점
    - 1. 단일 바이너리로 손쉽게 실행하고 사용할 수 있다.
    - 2. Prometheus 대비 2~10배 가량 빠르고 리소스를 적게 사용한다.
  -  단점
     -  1. 수집하는 데이터가 수천만 개 이상으로 증가하면 단일 장비(인스턴스)로는 감당이 안 될 수 있다.
     -  단일 장비가 SPOF(single point of failure)로 작용한다.

- Cluster 버전
  - 장점
    - 1. 저장되는 시계열 스케일에 맞춰 read, write, storage 컴포넌트의 scale out이 선형적으로 가능하다(Prometheus의 가장 큰 한계).
    - 2. replication factor를 적용하여 일정 부분 시계열 데이터 유실을 방지할 수 있다.
  - 단점
    - 1. SingleNode 버전에 비해 구조가 복잡하고 운영이 어렵다.

단일 클러스터 과부하
-
서로 다른 데이터 접근 패턴의 컴포넌트가 존재하여 VictoriaMetrics의 캐시 미스와 과부하가 자주 발생하는 경우, 단일 클러스터로는 부하를 감당하기 어려울 수 있다.

네이버 검색 SRE에서는 단일 클러스터 과부하를 해결하기 위해 다음 2가지 방법을 사용했다.

1. 멀티 클러스터 운영
   - 추상화 레벨과 시각화/알림의 접근 패턴별로 클러스터를 분리
   - 사용자 컴포넌트가 서로에게 영향을 주고받는 부분을 제거해 클러스터 장애 상황 시 영향을 최소화
2. 지표 선계산
   - 시각화 대시보드에서 서비스 지표를 하루 혹은 그 이상의 범위로 조회하는 요청은 부하가 크다. (대략 조회가 많이 필요한 걸리는 작업을 선계산 하였다는 이야기)
   
멀티 클러스터 운영의 어려움
-
시계열 데이터베이스 사용자는 시계열 데이터베이스에 운영 이슈(버전 업그레이드, 장비 교체, 배포, IDC 장애 등)가 생기면 엔드포인트를 변경하여 대체 클러스터를 사용해야 한다.

즉, 내부 운영 이슈를 처리하기 위해 사용자와 커뮤니케이션 비용이 발생한다. 사용자에게 이슈 상황마다 배포 혹은 대체 클러스터로 엔드포인트 변경을 요청해야 하며 사용자는 변경 배포가 필요하다. 최악의 경우 특정 IDC 인프라 장애로 네이버 검색의 장애 관제 및 모니터링 자체가 중단되어 사용자 배포 전까지 복구가 지연될 수 있다.

**해결책: 라우팅 게이트웨이 적용**
사용자가 직접 엔드포인트를 변경하는 대신 시계열 데이터베이스 클러스터 운영자가 사용자를 적절한 클러스터로 라우팅하는 게이트웨이를 적용

라우팅 게이트웨이로는 VictoriaMetrics의 vmauth를 래핑하여 사용

- 사용자별 데이터 접근 패턴 및 부하 발생량에 맞춰 라우팅 및 로드밸런싱 제공
- 인증된 사용자만 클러스터에 접근할 수 있으므로(vmauth의 basic auth기능 사용) 예상되지 않은 부하에 대처 가능
- 사용자별 부하 발생 및 요청 수 모니터링 가능
- 버전 업그레이드, 장비 교체 등 운영 이슈 발생 시 내부 라우팅 설정 변경만으로 대체 클러스터로 라우팅 제공
- 특정 IDC 인프라 장애 등 비상 상황 시 사용자의 배포 없이 빠르게 라우팅 포인트 변경 가능

이렇게 게이트웨이를 적용함으로써 여러 개의 클러스터를 운영하더라도 사용자와의 커뮤니케이션 비용을 줄이고 내부 유지 보수 작업을 용이하게 할 수 있다.
